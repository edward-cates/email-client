<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-size: 22px;
            font-weight: 400;
            color: #5f6368;
        }

        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 256px;
            background-color: #fff;
            border-right: 1px solid #e0e0e0;
            padding: 8px;
        }

        .auth-section {
            padding: 16px;
            margin-bottom: 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        .auth-section-title {
            font-size: 14px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 12px;
        }

        .account-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #fff;
        }

        .account-item.authenticated {
            border-color: #137333;
            background: #e6f4ea;
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .account-name {
            font-size: 13px;
            font-weight: 500;
            color: #202124;
        }

        .account-email {
            font-size: 12px;
            color: #5f6368;
            margin-bottom: 8px;
        }

        .account-email.authenticated {
            color: #137333;
        }

        .auth-btn {
            width: 100%;
            padding: 6px 12px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .auth-btn:hover {
            background-color: #1557b0;
        }

        .auth-btn.authenticated {
            background-color: #137333;
            cursor: default;
        }

        .auth-status {
            font-size: 11px;
            color: #5f6368;
            margin-top: 4px;
        }

        .auth-status.authenticated {
            color: #137333;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #fff;
        }

        .email-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .email-count {
            font-size: 14px;
            color: #5f6368;
        }

        .progress-container {
            padding: 8px 16px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #1a73e8;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .progress-text {
            font-size: 12px;
            color: #5f6368;
            margin-top: 4px;
        }

        .email-list {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        .loading-more {
            padding: 16px;
            text-align: center;
            color: #5f6368;
            font-size: 13px;
        }

        .loading-more-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e0e0e0;
            border-top-color: #1a73e8;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .email-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .email-item:hover {
            background-color: #f8f9fa;
        }

        .email-account {
            min-width: 100px;
            font-size: 11px;
            color: #5f6368;
            padding: 2px 6px;
            background: #f1f3f4;
            border-radius: 4px;
        }

        .email-sender {
            min-width: 200px;
            font-size: 14px;
        }

        .email-subject {
            flex: 1;
            font-size: 14px;
        }

        .email-preview {
            flex: 1;
            color: #5f6368;
            font-size: 13px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .email-labels {
            min-width: 150px;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .email-label {
            padding: 2px 8px;
            background-color: #e8f0fe;
            border-radius: 12px;
            font-size: 11px;
            color: #1a73e8;
        }

        .email-actions {
            display: flex;
            gap: 8px;
            min-width: 120px;
        }

        .action-btn {
            padding: 6px 12px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            font-size: 12px;
            color: #5f6368;
        }

        .action-btn:hover {
            background-color: #f1f3f4;
        }

        .action-btn.archive {
            color: #ea4335;
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #5f6368;
        }

        .empty-state-icon {
            font-size: 120px;
            margin-bottom: 16px;
        }

        .loading {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #5f6368;
        }

        .error {
            padding: 16px;
            background-color: #fce8e6;
            color: #c5221f;
            border-radius: 4px;
            margin: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">Gmail - Merged Inbox</div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="auth-section">
                <div class="auth-section-title">Accounts</div>
                <div id="accountsList">Loading accounts...</div>
            </div>
        </div>

        <div class="content-area">
            <div class="email-header">
                <div class="email-count" id="emailCount">Loading...</div>
            </div>
            <div class="progress-container" id="progressContainer" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
                <div class="progress-text" id="progressText">Loading emails...</div>
            </div>
            <div class="email-list" id="emailList">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        let accounts = [];
        let emailAccountMap = {}; // Map message_id to account_id
        let allEmails = []; // Store all loaded emails
        let nextPageToken = null;
        let totalEmailCount = 0;
        let isLoading = false;
        let hasMoreEmails = true;
        const BATCH_SIZE = 20; // Number of emails to load per batch

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('auth_success') === 'true') {
            setTimeout(() => {
                loadAccounts();
                initializeEmails();
            }, 500);
        }
        if (urlParams.get('auth_error')) {
            showError('Authentication failed: ' + urlParams.get('auth_error'));
        }

        loadAccounts();
        initializeEmails();

        // Set up infinite scroll
        const emailList = document.getElementById('emailList');
        emailList.addEventListener('scroll', handleScroll);

        async function loadAccounts() {
            try {
                const response = await fetch('/api/accounts');
                const data = await response.json();
                accounts = data.accounts;
                renderAccounts();
            } catch (error) {
                console.error('Error loading accounts:', error);
                document.getElementById('accountsList').innerHTML = '<div class="error">Error loading accounts</div>';
            }
        }

        function renderAccounts() {
            const accountsList = document.getElementById('accountsList');
            if (accounts.length === 0) {
                accountsList.innerHTML = '<div style="color: #5f6368; font-size: 12px;">No accounts found. Add credentials-1.json through credentials-9.json to src/gmail/credentials/</div>';
                return;
            }

            accountsList.innerHTML = accounts.map(account => {
                const accountNum = account.account_id.replace('account', '');
                if (account.authenticated) {
                    return `
                        <div class="account-item authenticated">
                            <div class="account-header">
                                <div class="account-name">Account ${accountNum}</div>
                                <span style="color: #137333; font-size: 12px;">âœ“</span>
                            </div>
                            <div class="account-email authenticated">${escapeHtml(account.email || 'Authenticated')}</div>
                            <div class="auth-status authenticated">Authenticated</div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="account-item">
                            <div class="account-header">
                                <div class="account-name">Account ${accountNum}</div>
                            </div>
                            <div class="account-email">Not authenticated</div>
                            <button class="auth-btn" onclick="startAuth('${escapeHtml(account.account_id)}')">Sign in</button>
                        </div>
                    `;
                }
            }).join('');
        }

        async function startAuth(accountId) {
            try {
                const response = await fetch(`/api/auth/start?account_id=${accountId}`);
                const data = await response.json();
                window.location.href = data.authorization_url;
            } catch (error) {
                showError('Failed to start authentication: ' + error.message);
            }
        }

        async function initializeEmails() {
            allEmails = [];
            nextPageToken = null;
            hasMoreEmails = true;
            
            const emailList = document.getElementById('emailList');
            emailList.innerHTML = '<div class="loading">Loading emails...</div>';
            
            // Load total count first
            try {
                const countResponse = await fetch('/api/emails/total-count');
                if (countResponse.ok) {
                    const countData = await countResponse.json();
                    totalEmailCount = countData.total_count;
                    updateEmailCount(0);
                }
            } catch (error) {
                console.error('Error loading email count:', error);
            }
            
            // Load initial batch
            await loadMoreEmails(true);
        }

        async function loadMoreEmails(isInitial = false) {
            if (isLoading || (!hasMoreEmails && !isInitial)) {
                return;
            }

            isLoading = true;
            const emailList = document.getElementById('emailList');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            // Show progress on initial load
            if (isInitial) {
                progressContainer.style.display = 'block';
                progressFill.style.width = '0%';
                progressText.textContent = 'Loading emails...';
                allEmails = []; // Clear existing emails on initial load
            }

            try {
                // Use streaming endpoint for initial load, regular endpoint for pagination
                if (isInitial) {
                    await loadEmailsStream();
                } else {
                    await loadEmailsRegular();
                }

                // Render emails
                renderEmails();

                // Hide progress after initial load completes
                if (isInitial) {
                    if (!hasMoreEmails) {
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                        }, 500);
                    } else {
                        progressContainer.style.display = 'block';
                    }
                }

            } catch (error) {
                console.error('Error loading emails:', error);
                if (isInitial) {
                    emailList.innerHTML = `<div class="error">Error loading emails: ${error.message}</div>`;
                } else {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error';
                    errorDiv.textContent = `Error loading more emails: ${error.message}`;
                    emailList.appendChild(errorDiv);
                }
            } finally {
                isLoading = false;
            }
        }

        async function loadEmailsStream() {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            return new Promise((resolve, reject) => {
                let url = `/api/emails/merged/stream?max_results=${BATCH_SIZE}`;
                if (nextPageToken) {
                    url += `&page_token=${encodeURIComponent(nextPageToken)}`;
                }

                const eventSource = new EventSource(url);
                const newEmails = [];
                let streamComplete = false;

                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'progress') {
                            // Update progress bar
                            const progress = data.progress_percent || 0;
                            progressFill.style.width = progress + '%';
                            progressText.textContent = `Loading ${data.overall_current} of ${data.overall_total} emails from ${data.account_id}...`;
                        } else if (data.type === 'email') {
                            // Add email as it arrives
                            const email = data.email;
                            emailAccountMap[email.id] = email.account_id;
                            
                            // Check for duplicates
                            if (!allEmails.find(e => e.id === email.id)) {
                                allEmails.push(email);
                                newEmails.push(email);
                            }
                            
                            // Render incrementally for better UX
                            if (newEmails.length % 5 === 0) {
                                renderEmails();
                            }
                        } else if (data.type === 'account_start') {
                            progressText.textContent = `Fetching from ${data.account_id} (${data.account_num}/${data.total_accounts})...`;
                        } else if (data.type === 'account_complete') {
                            progressText.textContent = `Completed ${data.account_id}: ${data.count} emails`;
                        } else if (data.type === 'complete') {
                            streamComplete = true;
                            nextPageToken = data.next_page_token || null;
                            hasMoreEmails = !!nextPageToken;
                            
                            // Sort emails by date (newest first)
                            allEmails.sort((a, b) => {
                                const dateA = parseInt(a.internalDate || 0);
                                const dateB = parseInt(b.internalDate || 0);
                                return dateB - dateA;
                            });
                            
                            const loadedCount = allEmails.length;
                            if (totalEmailCount > 0) {
                                const progress = Math.min((loadedCount / totalEmailCount) * 100, 100);
                                progressFill.style.width = progress + '%';
                                progressText.textContent = `Loaded ${loadedCount} of ${totalEmailCount} emails`;
                            } else {
                                progressText.textContent = `Loaded ${loadedCount} emails`;
                            }
                            
                            eventSource.close();
                            resolve();
                        } else if (data.type === 'error') {
                            eventSource.close();
                            reject(new Error(data.message || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('Error parsing stream data:', error);
                    }
                };

                eventSource.onerror = (error) => {
                    eventSource.close();
                    if (!streamComplete) {
                        reject(new Error('Stream connection error'));
                    }
                };

                // Timeout after 60 seconds
                setTimeout(() => {
                    if (!streamComplete) {
                        eventSource.close();
                        reject(new Error('Stream timeout'));
                    }
                }, 60000);
            });
        }

        async function loadEmailsRegular() {
            let url = `/api/emails/merged?max_results=${BATCH_SIZE}`;
            if (nextPageToken) {
                url += `&page_token=${encodeURIComponent(nextPageToken)}`;
            }

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Failed to load emails');
            }

            const data = await response.json();
            nextPageToken = data.next_page_token || null;
            hasMoreEmails = !!nextPageToken;

            const newEmails = data.emails || [];
            newEmails.forEach(email => {
                emailAccountMap[email.id] = email.account_id;
            });

            const existingIds = new Set(allEmails.map(e => e.id));
            const uniqueNewEmails = newEmails.filter(e => !existingIds.has(e.id));
            allEmails.push(...uniqueNewEmails);
        }

        function renderEmails() {
            const emailList = document.getElementById('emailList');
            
            if (allEmails.length === 0) {
                const hasAuthenticated = accounts.some(a => a.authenticated);
                if (!hasAuthenticated) {
                    emailList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ”’</div><div>Please sign in to at least one account to view emails</div></div>';
                } else {
                    emailList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“­</div><div>No emails found</div></div>';
                }
                updateEmailCount(0);
                return;
            }

            const emailsHtml = allEmails.map(email => {
                const labelsHtml = email.labels
                    .filter(label => label !== 'INBOX' && label !== 'UNREAD' && label !== 'READ')
                    .map(label => `<span class="email-label">${escapeHtml(label)}</span>`)
                    .join('');

                const accountNum = email.account_id.replace('account', '');
                const accountEmail = accounts.find(a => a.account_id === email.account_id)?.email || `Account ${accountNum}`;

                return `
                    <div class="email-item" data-message-id="${escapeHtml(email.id)}">
                        <div class="email-account" title="${escapeHtml(accountEmail)}">${accountNum}</div>
                        <div class="email-sender">${escapeHtml(parseSender(email.from))}</div>
                        <div class="email-subject">${escapeHtml(email.subject)}</div>
                        <div class="email-preview">${escapeHtml(email.snippet)}</div>
                        <div class="email-labels">${labelsHtml || '<span style="color: #999;">No labels</span>'}</div>
                        <div class="email-actions">
                            <button class="action-btn archive" onclick="archiveEmail('${escapeHtml(email.id)}')">Archive</button>
                            <button class="action-btn" onclick="showAddLabel('${escapeHtml(email.id)}')">Add Label</button>
                        </div>
                    </div>
                `;
            }).join('');

            // Add loading indicator if there are more emails
            let loadingMoreHtml = '';
            if (hasMoreEmails && isLoading) {
                loadingMoreHtml = '<div class="loading-more"><span class="loading-more-spinner"></span>Loading more emails...</div>';
            } else if (hasMoreEmails) {
                loadingMoreHtml = '<div class="loading-more" id="loadMoreTrigger"></div>';
            }

            emailList.innerHTML = emailsHtml + loadingMoreHtml;
            updateEmailCount(allEmails.length);
        }

        function updateEmailCount(count) {
            const emailCountEl = document.getElementById('emailCount');
            if (totalEmailCount > 0) {
                emailCountEl.textContent = `Showing ${count} of ${totalEmailCount} emails`;
            } else {
                emailCountEl.textContent = count > 0 ? `${count} emails` : 'No emails';
            }
        }

        function handleScroll() {
            const emailList = document.getElementById('emailList');
            const scrollTop = emailList.scrollTop;
            const scrollHeight = emailList.scrollHeight;
            const clientHeight = emailList.clientHeight;

            // Load more when user scrolls to within 200px of the bottom
            if (scrollHeight - scrollTop - clientHeight < 200) {
                if (hasMoreEmails && !isLoading) {
                    loadMoreEmails(false);
                }
            }
        }

        async function archiveEmail(messageId) {
            const accountId = emailAccountMap[messageId];
            if (!accountId) {
                alert('Error: Could not determine account for this email');
                return;
            }

            try {
                const response = await fetch(`/api/emails/${messageId}/archive?account_id=${accountId}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Failed to archive email');
                }

                // Remove archived email from the list
                allEmails = allEmails.filter(e => e.id !== messageId);
                renderEmails();
            } catch (error) {
                alert('Error archiving email: ' + error.message);
            }
        }

        async function showAddLabel(messageId) {
            const accountId = emailAccountMap[messageId];
            if (!accountId) {
                alert('Error: Could not determine account for this email');
                return;
            }

            const labelName = prompt('Enter label name:');
            if (!labelName) return;

            try {
                const response = await fetch(`/api/emails/${messageId}/labels?account_id=${accountId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ label_names: [labelName] })
                });

                if (!response.ok) {
                    throw new Error('Failed to add label');
                }

                // Reload emails to get updated labels
                initializeEmails();
            } catch (error) {
                alert('Error adding label: ' + error.message);
            }
        }

        function parseSender(from) {
            const match = from.match(/^(.+?)\s*<(.+)>$/);
            if (match) {
                return match[1].trim() || match[2];
            }
            return from;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            const emailList = document.getElementById('emailList');
            emailList.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
        }
    </script>
</body>
</html>
